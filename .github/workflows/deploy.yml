name: FinOrbit CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-test-deploy:
    name: ðŸ§ª Build, Test & Deploy FinOrbit
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      TF_IN_AUTOMATION: true
      COVERAGE_THRESHOLD: 70.0
      GO_ENV: test   # <-- variÃ¡vel de ambiente para testes

    steps:
      # ===============================
      # 1ï¸âƒ£ Checkout do repositÃ³rio
      # ===============================
      - name: ðŸ“¥ Checkout do cÃ³digo
        uses: actions/checkout@v4

      # ===============================
      # 2ï¸âƒ£ Configurar Go
      # ===============================
      - name: ðŸ§° Configurar Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.25'

      # ===============================
      # 3ï¸âƒ£ Testes unitÃ¡rios (Consumer)
      # ===============================
      - name: ðŸ§ª Testes - Consumer
        id: consumer_tests
        working-directory: ./consumer
        env:
          GO_ENV: test
          COVERAGE_THRESHOLD: ${{ env.COVERAGE_THRESHOLD }}
        run: |
          set -e
          go mod tidy
          go test -v -coverprofile=coverage.out ./...
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Cobertura Consumer: $coverage%"
          cov_int=$(echo "$coverage < $COVERAGE_THRESHOLD" | bc)
          if [ "$cov_int" -eq 1 ]; then
            echo "âŒ Cobertura abaixo de $COVERAGE_THRESHOLD% ($coverage%)"
            exit 1
          fi

      # ===============================
      # 4ï¸âƒ£ Testes unitÃ¡rios (Producer)
      # ===============================
      - name: ðŸ§ª Testes - Producer
        id: producer_tests
        working-directory: ./producer
        env:
          GO_ENV: test
          COVERAGE_THRESHOLD: ${{ env.COVERAGE_THRESHOLD }}
        run: |
          set -e
          go mod tidy
          go test -v -coverprofile=coverage.out ./...
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Cobertura Producer: $coverage%"
          cov_int=$(echo "$coverage < $COVERAGE_THRESHOLD" | bc)
          if [ "$cov_int" -eq 1 ]; then
            echo "âŒ Cobertura abaixo de $COVERAGE_THRESHOLD% ($coverage%)"
            exit 1
          fi

      # ===============================
      # 5ï¸âƒ£ Upload dos relatÃ³rios de cobertura
      # ===============================
      - name: ðŸ“¤ Upload de relatÃ³rios de cobertura
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            consumer/coverage.out
            producer/coverage.out

      # ===============================
      # 6ï¸âƒ£ Configurar AWS
      # ===============================
      - name: âš™ï¸ Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ðŸ³ Login no ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ===============================
      # 7ï¸âƒ£ Build e Push das imagens Docker
      # ===============================
      - name: ðŸ§± Build e Push Consumer
        working-directory: ./consumer
        env:
          ECR_REPOSITORY: finorbit-consumer
          AWS_REGION: ${{ env.AWS_REGION }}
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          set -e
          docker build -t $ECR_REPOSITORY:latest .
          docker tag $ECR_REPOSITORY:latest $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest
          docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest

      - name: ðŸ§± Build e Push Producer
        working-directory: ./producer
        env:
          ECR_REPOSITORY: finorbit-producer
          AWS_REGION: ${{ env.AWS_REGION }}
          ACCOUNT_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          set -e
          docker build -t $ECR_REPOSITORY:latest .
          docker tag $ECR_REPOSITORY:latest $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest
          docker push $ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:latest

      # ===============================
      # 8ï¸âƒ£ Instalar e aplicar Terraform
      # ===============================
      - name: ðŸ§© Instalar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7

      - name: ðŸª„ Terraform Init
        run: terraform init

      - name: ðŸ§® Terraform Plan
        run: terraform plan -out=tfplan

      - name: ðŸš€ Terraform Apply (auto)
        run: terraform apply -auto-approve tfplan

      # ===============================
      # ðŸ”Ÿ Outputs finais
      # ===============================
      - name: ðŸŒ Mostrar endpoints da API
        run: |
          terraform output || echo "âš ï¸ Nenhum output configurado"
