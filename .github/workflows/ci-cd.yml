name: FinOrbit CI/CD

on:
  push:
    branches: [main]
    paths-ignore:
      - 'infra/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  COVERAGE_THRESHOLD: 70.0

jobs:
  # ===============================
  # 1Ô∏è‚É£ Testes (sempre no push)
  # ===============================
  lint-test:
    name: üß™ Lint & Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [consumer, producer]
    defaults:
      run:
        working-directory: ./${{ matrix.service }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.25"
      - run: go fmt ./...
      - run: |
          set -e
          go mod tidy
          go test -v -coverprofile=coverage.out ./...
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print substr($3, 1, length($3)-1)}')
          echo "Cobertura ${{ matrix.service }}: $coverage%"
          cov_int=$(echo "$coverage < $COVERAGE_THRESHOLD" | bc)
          if [ "$cov_int" -eq 1 ]; then
            echo "‚ùå Cobertura abaixo de $COVERAGE_THRESHOLD%"
            exit 1
          fi

  # ===============================
  # 2Ô∏è‚É£ Docker Build & Push
  # ===============================
  docker:
    name: üê≥ Build & Push Images
    runs-on: ubuntu-latest
    needs: lint-test
    strategy:
      matrix:
        service: [consumer, producer]
    defaults:
      run:
        working-directory: ./${{ matrix.service }}
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
      - run: |
          set -e
          REPO=finorbit-${{ matrix.service }}
          ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
          REGION=${{ env.AWS_REGION }}

          echo "üîç Garantindo que o reposit√≥rio ECR exista..."
          aws ecr describe-repositories --repository-names $REPO >/dev/null 2>&1 || \
            aws ecr create-repository --repository-name $REPO >/dev/null

          echo "üèóÔ∏è Buildando imagem Docker..."
          docker build -t $REPO:latest .

          echo "üì¶ Tag & Push..."
          docker tag $REPO:latest $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$REPO:latest
          docker push $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/$REPO:latest

  # ===============================
  # 3Ô∏è‚É£ Terraform Deploy (Services)
  # ===============================
  deploy-services:
    name: üöÄ Terraform Deploy (Services)
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - uses: actions/checkout@v4
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.7
      - run: terraform init -upgrade
        working-directory: ./services
      - run: |
          terraform apply -auto-approve \
            -var="producer_image_tag=latest" \
            -var="consumer_image_tag=latest"
        working-directory: ./services

  # ===============================
  # 4Ô∏è‚É£ Deploy Lambdas (atualiza c√≥digo)
  # ===============================
  deploy-lambdas:
    name: ‚ö° Update Lambda Images
    runs-on: ubuntu-latest
    needs: docker
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - run: |
          ACCOUNT_ID=${{ secrets.AWS_ACCOUNT_ID }}
          REGION=${{ env.AWS_REGION }}

          echo "üöÄ Atualizando Lambdas com novas imagens..."
          aws lambda update-function-code --function-name finorbit-dev-producer \
            --image-uri $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/finorbit-producer:latest

          aws lambda update-function-code --function-name finorbit-dev-consumer-deposit \
            --image-uri $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/finorbit-consumer:latest

          aws lambda update-function-code --function-name finorbit-dev-consumer-withdraw \
            --image-uri $ACCOUNT_ID.dkr.ecr.$REGION.amazonaws.com/finorbit-consumer:latest
